---
alwaysApply: false
---
Defines how to create a **new feature module** consistent with system design.

## Quick Reference

| What | Where |
|------|-------|
| Domain entities | `lib/domain/entities/<feature>/` |
| Repository interface | `lib/domain/repositories/<feature>_repository.dart` |
| Repository impl | `lib/data/repositories/<feature>_repository_impl.dart` |
| DAO | `lib/data/local/daos/<feature>_dao.dart` |
| Mappers | `lib/data/mappers/<entity>_mapper.dart` |
| Providers | `lib/features/<feature>/logic/` |
| Test plan | `test/plans/<feature>_test_plan.md` |
| Fake builders | `test/mocks/fake_data/<feature>_fakes.dart` |
| Test runners | `test/runners/<feature>/` |

# FEATURE CREATION WORKFLOW

## Files to Create (per feature)

| Layer | Location | Files |
|-------|----------|-------|
| Domain Entities | `lib/domain/entities/<feature>/` | `<entity>.dart`, `<feature>_constants.dart` |
| Domain Exceptions | `lib/domain/exceptions/` | `<feature>_exception.dart` |
| Domain Repository | `lib/domain/repositories/` | `<feature>_repository.dart` |
| Domain Use Cases | `lib/domain/usecases/<feature>/` | One file per use case |
| Data Tables | `lib/data/local/models/` | `<entity>_table.dart` |
| Data DAO | `lib/data/local/daos/` | `<feature>_dao.dart` |
| Data Mappers | `lib/data/mappers/` | `<entity>_mapper.dart` |
| Data Repository | `lib/data/repositories/` | `<feature>_repository_impl.dart` |
| Feature Logic | `lib/features/<feature>/logic/` | Providers + state |
| Feature UI | `lib/features/<feature>/ui/` | Screens + widgets |

## Feature Creation Workflow

### STEP 1: Domain Layer (Pure Dart)
- Entities in `domain/entities/<feature>/`
- Repository interface in `domain/repositories/`
- Use cases in `domain/usecases/<feature>/`
- Exceptions in `domain/exceptions/`
- Constants in `domain/entities/<feature>/`

### STEP 2: Data Layer
- Drift tables in `data/local/models/`
- DAO in `data/local/daos/`
- Mappers in `data/mappers/`
- Repository impl in `data/repositories/`

### STEP 3: Feature Layer
- Logic (providers/state) in `features/<feature>/logic/`
- UI (screens/widgets) in `features/<feature>/ui/`

### STEP 4: Integration
- Register providers in `core/di/main_providers.dart`
- Add any necessary PII scrubbing in `core\monitoring\pii_scrubber.dart`
- Add routes in `app/router/`

### STEP 5: Testing
- Test plan, fakes, runners, and tests (see Testing Checklist)

## Testing Checklist

1. **Create test plan**: `test/plans/<feature>_test_plan.md`
2. **Create fake builders**: `test/mocks/fake_data/<feature>_fakes.dart`
3. **Export mocks**: Add to `test/mocks/mock_repositories.dart`
4. **Add tag to dart_test.yaml**: Under `tags:` section
5. **Tag all test files**: `@Tags(['<feature>'])`
6. **Create test runners**: `test/runners/<feature>/` (quick, unit, all)
7. **Write tests** (in order):
   - Domain entity tests
   - Domain exception tests
   - Domain use case tests (mock repository)
   - Data mapper tests
   - Data DAO tests (in-memory DB)
   - Data repository tests
   - Logic/provider tests
   - Integration tests (optional)
   - Performance tests (optional)

# FEATURE NAMING RULES
- Feature names in snake_case → `file_upload`, `biomarkers`, `timeline`
- Providers → `<feature>_provider.dart`
- States → `<feature>_state.dart`
- Use cases → verb-noun pattern → `FetchBiomarkers`, `SaveSymptomLog`
- Entities → singular noun → `Biomarker`, `SymptomLog`

# VALIDATION
Before finalizing:
✅ Domain entities are Flutter/DB-agnostic  
✅ Repositories correctly bridge domain ↔ data  
✅ Providers connect use cases to UI only  
✅ Tests exist for each layer


